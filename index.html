<html>

<head>
	<title>Marisa Danmaku</title>
	
	<!-- Browser FaviCon -->
	<link rel="icon" type="img/png" href="img/icon/ico.png" />

	<!-- StyleSheet -->
	<link rel="stylesheet" type="text/css" href="css/styles.css" />
	
	<!-- My Custom Fonts -->
	<link href='http://fonts.googleapis.com/css?family=Bilbo+Swash+Caps' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Skranji' rel='stylesheet' type='text/css'>
</head>

<body>

<div id="content_wrapper" align="center">
        
        <div id="game_wrapper">
	
	<div id="canvas_wrapper">
	
		<canvas id="bg_canv" width="500" height="550"></canvas>
		<canvas id="fx1canv" width="500" height="550"></canvas>
		<canvas id="canv" width="500" height="550">No canvas !? You must be using a Microsoft Product.</canvas>
		
		
	</div><!-- canvas_wrapper -->
		
	<div id="game_hud">
		            <b>Informations</b>
		            
		            <br />
		            
			Frame: <span id="frame">0</span><br />
			Score: <span id="score">0</span><br />
			Power: <span id="power">0</span><br />
			Bombs: <span id="bombs">0</span><br />
			Grazing: <span id="grazeplus">0</span><br />
			Grazing points: <span id="gr">0</span><br />
			Current Level: <span id="level">0</span><br />
			Marisa Health: <span id="mh">0</span><br />
			<br />
			SpellCard Special: <span id="spell">0</span><br />
			<br />
			Onscreen enemies: <span id="oe">0</span><br />
			Onscreen bullets: <span id="ob">0</span><br />
			Onscreen powerups: <span id="op">0</span><br />
			<br />
			<b>Controls</b><br />
			Move: arrow keys<br />
			Shoot: Z<br />
			Bomb: X<br />
			Spell: C<br />
			Slow: L-Shift<br />
			<br />
			<input type="button" class="button" onClick="javascript:play();" value="Play!" />
			<input type="button" class="button" onClick="javascript:stop();" value="Stop!" />
			<form name="gameMode" class="GameModeControls">
			<br style='clear: both' />
			        <input type="checkbox" name="mode" id="box1" checked> 	<label for="box1">Die in Game</label> <br />
			        <input type="checkbox" name="mode" id="box2"> 	<label for="box2">Dont Die in Game</label><br />
			        <input type="checkbox" name="mode" id="box3"> 	<label for="box3">Full Power</label><br />
			        <input type="checkbox" name="mode" id="box4"> 	<label for="box4">Start at level 2</label><br />
			        <input type="checkbox" name="mode" id="box5"> 	<label for="box5">Start at level 3</label><br />
			        <input type="checkbox" name="mode" id="box6"> 	<label for="box6">Start at level 4</label><br />
					
			        <input type="checkbox" name="mode" id="box7" checked onClick="javascript:toggleMusic()">
				<label for="box7">Music</label>
			        <input id="MusicVolume" type="range" min="0" max="1" step="0.01" value="0.5" onchange="ChangeMusicVolume(this.value);"  />
			        <br />					
			        <input type="checkbox" name="mode" id="box8" checked> 
				<label for="box8">Sfx</label>
			        <input id="SfxVolume" type="range" min="0" max="1" step="0.01" value="0.5"  />
			        <br />
			</form>
			
			<div id="play_score">
			        <b>
				<u>
				        <font style="color:#dddddd; font-size: 18pt;">Total Score: </font>
				</u>
			        </b>
			        <span id="total">0</span>
			</div><!-- play_score -->
		             
		</div><!-- game_hud -->
		<div style="clear: both;"></div>
		
		<div id="footer">
		
			<span id="script"></span> 
		
		</div><!-- footer -->
		
	</div><!-- game_wrapper -->
	<br />
	
	<div class="reimu"><img src="img/bg/reimu.png" /></div>
	<div class="marisa"><img src="img/bg/marisa.png" /></div>
	
</div><!-- content_wrapper -->
<div id="images" style="display: none;">
	<img id="ex" src="img/098.png" />	<!-- enemy bullets -->
	<img id="s" src="img/199.png" />
	<img id="p" src="img/056.png" />
	<img id="spec" src="img/032.png" />
	<img id="b6a" src="img/b6a.png" />
	<img id="b8a" src="img/b8a.png" />
	<img id="b8b" src="img/b8b.png" />
	<img id="b8c" src="img/b8c.png" />
	<img id="b8d" src="img/b8d.png" />
	<img id="b8e" src="img/b8e.png" />
	<img id="b8f" src="img/b8f.png" />
	<img id="b8g" src="img/b8g.png" />
	<img id="b8h" src="img/b8h.png" />
	<img id="b8i" src="img/b8i.png" />
	<img id="b8j" src="img/b8j.png" />
	<img id="b16a" src="img/b16a.png" />
	<img id="b16b" src="img/b16b.png" />
	<img id="b16c" src="img/b16c.png" />
	<img id="b16d" src="img/b16d.png" />
	<img id="b16e" src="img/b16e.png" />
	<img id="b16f" src="img/b16f.png" />
	<img id="b16g" src="img/b16g.png" />
	<img id="b16h" src="img/b16h.png" />
	<img id="b16i" src="img/b16i.png" />
	<img id="b16j" src="img/b16j.png" />
	<img id="bp" src="img/bp.png" />	<!-- player bullet -->
	<img id="bpA" src="img/bpA.png" />	<!-- player powerup bullet blue -->
	<img id="bb1" src="img/bb1.png" />	<!-- player spell bullet -->
	<img id="bb2" src="img/bb2.png" />	<!-- player powerup bullet grey -->
	<img id="pg" src="img/154.png" />	<!-- player sprite -->
	<img id="pg_slw" src="img/154_slow.png" />	<!-- player sprite 'slow' -->
	<img id="e1" src="img/157.png" />	<!-- enemy sprites -->
	<img id="e2" src="img/152.png" />
	<img id="e3" src="img/153.png" />
	<img id="e4" src="img/099.png" />
	<img id="e5" src="img/100.png" />	<!-- Boss: Scarlet Devil -->
	<img id="e6" src="img/161.png" />	<!-- fairy: blue -->
	<img id="e7" src="img/162.png" />	<!-- fairy: pink -->
	<img id="bs2" src="img/bs2.png" />	<!-- Boss: Keine Kamishirasawa -->
	<img id="bss2" src="img/bss2.png" />	<!-- Boss: Kurimi -->
	<img id="bss3" src="img/bss3.png" />	<!-- Boss: Alice -->
</div><!-- images -->

</body>

</html>

<script type="text/javascript">

// inheritance function
function extend(childClassOrObject, parentClassOrObject)
{ 
	childClassOrObject.prototype = new parentClassOrObject;
	childClassOrObject.prototype.constructor = childClassOrObject;
}

</script>
<!-- Game Elements -->
<script type="text/javascript" src="js/Background.js"></script>
<script type="text/javascript" src="js/Movement.js"></script>
<script type="text/javascript" src="js/SpellCard.js"></script>
<script type="text/javascript" src="js/Sprite.js"></script>
<script type="text/javascript" src="js/Player.js"></script>
<script type="text/javascript" src="js/PlayerBullet.js"></script>
<script type="text/javascript" src="js/Enemy.js"></script>
<script type="text/javascript" src="js/EnemyBullet.js"></script>
<script type="text/javascript" src="js/Powerup.js"></script>
<script type="text/javascript" src="js/Explosion.js"></script>
<script type="text/javascript" src="js/Text.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript" src="js/Audio.js"></script>
<!-- Level Engine -->
<script type="text/javascript" src="js/Level.js"></script>
<!-- levels -->
<script type="text/javascript" src="levels/level1.js"></script>
<script type="text/javascript" src="levels/level2.js"></script>
<script type="text/javascript" src="levels/level3.js"></script>
<script type="text/javascript" src="levels/level4.js"></script>

<script type="text/javascript">

// canvas variables
var bg_canv = document.getElementById('bg_canv');
var bg_ctx = bg_canv.getContext('2d');

var fx1canv = document.getElementById('fx1canv');
var fx1canv = fx1canv.getContext('2d');

var canv = document.getElementById('canv');
var ctx = canv.getContext('2d');

// document text elements
var frame_text = document.getElementById('frame');
var score_text = document.getElementById('score');
var power_text = document.getElementById('power');
var bombs_text = document.getElementById('bombs');
var graze_text = document.getElementById('grazeplus');
var total_text = document.getElementById('total');
var level_text = document.getElementById('level');
var spell_text = document.getElementById('spell');
var script_txt = document.getElementById('script');

// 1st Script
script_txt.innerHTML = "It was quiet around Marisa Kirisames little house,<br /> too quiet and a little boring.<br>There were rumours about humans dissappearing from the village and Marisa had a vision about a powerfull unknown Magic involved, Marisa decides to investigate.";

var oe_text = document.getElementById('oe');
var ob_text = document.getElementById('ob');
var op_text = document.getElementById('op');
var mh_text = document.getElementById('mh');
var gr_text = document.getElementById('gr');

// document images
var img_p = document.getElementById('p');
var img_s = document.getElementById('s');
// enemies
var img_e1 = document.getElementById('e1');
var img_e2 = document.getElementById('e2');
var img_e3 = document.getElementById('e3');
var img_e4 = document.getElementById('e4');
var img_e6 = document.getElementById('e6');
var img_e7 = document.getElementById('e7');
// bullets
var img_b6a = document.getElementById('b6a');
var img_b8a = document.getElementById('b8a');
var img_b8b = document.getElementById('b8b');
var img_b8c = document.getElementById('b8c');
var img_b8d = document.getElementById('b8d');
var img_b8e = document.getElementById('b8e');
var img_b8f = document.getElementById('b8f');
var img_b8g = document.getElementById('b8g');
var img_b8h = document.getElementById('b8h');
var img_b8i = document.getElementById('b8i');
var img_b8j = document.getElementById('b8j');
var img_b16a = document.getElementById('b16a');
var img_b16b = document.getElementById('b16b');
var img_b16c = document.getElementById('b16c');
var img_b16d = document.getElementById('b16d');
var img_b16e = document.getElementById('b16e');
var img_b16f = document.getElementById('b16f');
var img_b16g = document.getElementById('b16g');
var img_b16h = document.getElementById('b16h');
var img_b16i = document.getElementById('b16i');
var img_b16j = document.getElementById('b16j');
var img_e5 = document.getElementById('e5');		// Scarlet Devil
var img_bs2 = document.getElementById('bs2');		// Keine Kamishirasawa
var img_bss2 = document.getElementById('bss2');		// Kurimi
var img_bss3 = document.getElementById('bss3');		// Alice Margatroid
var img_pg = document.getElementById('pg');		// player sprite
var img_pg_slw = document.getElementById('pg_slw');	// slow movement, show hitbox
var img_bp = document.getElementById('bp');		// player bullet
var img_bpA = document.getElementById('bpA');		// player bullet powerup blue
var img_bb1 = document.getElementById('bb1');		// spell bullet big
var img_bb2 = document.getElementById('bb2');		// spell bullet grey
var img_spc = document.getElementById('spec');		// spell special bullet

var img_ex = document.getElementById('ex');

// other variables
var now = 0;
var graze = 0;
var score = 0;
var bombs = 3;
var spell = 10;
var interval = 0;
var currentLevel = 1;

var bg = new Background();	 // background global variable 
var pg = new Player();	 // player global variable
var level = new Level();	 // level global variable

bg.clear();

// sprite arrays
var bullets = [];
var enemies = [];
var powerups = [];
var others = [];

// which buttons have been pressed
var up_p = 0;
var dw_p = 0;
var lf_p = 0;
var rg_p = 0;
var sh_p = 0;
var s2_p = 0;
var s3_p = 0;
var sm_p = 0;

// function to be called every frame, manages all the gameplay
function work()
{
	// handle background
	bg.work();
	
	// handle player
	pg.work();

	// handle enemies
	for (var i = 0; i < enemies.length; i++)
	{
		var o = enemies[i];
		o.work();
		
		if (o.dead == 1)
			enemies.splice(i, 1);
	}
	
	// handle bullets
	for (var i = 0; i < bullets.length; i++)
	{
		var o = bullets[i]; 
		o.work();
		
		if (o.dead == 1)
			bullets.splice(i, 1);
	}
  
	// handle powerups
	for (var i = 0; i < powerups.length; i++)
	{
		var o = powerups[i]; 
		o.work();
		
		if (o.dead == 1)
			powerups.splice(i, 1);
	}
	
	// handle other misc sprites
	for (var i = 0; i < others.length; i++)
	{
		var o = others[i]; 
		o.work();
		
		if (o.dead == 1)
			others.splice(i, 1);
	}

	// handle enemy spawning
	var spawned = this.level.spawn(); // get array of enemies spawn in the current frame
	
	for (var i = 0; i < spawned.length; i++)
	    enemies[enemies.length] = spawned[i];
	
	var graze_score = pg.graze * 10;
	
	// print stuff
	score_text.innerHTML = score;
	power_text.innerHTML = pg.power;
	
	        if (pg.power >= 60)
	        {
		        power_text.innerHTML = "MAX !!!"
	        }
	
	graze_text.innerHTML = graze_score;
	total_text.innerHTML = score + graze_score;
	level_text.innerHTML = currentLevel;
	bombs_text.innerHTML = bombs;
	spell_text.innerHTML = spell;
		
	        if ((score+graze_score) == 200000)
	        {
		        bombs += 1;
		        spell += 1;
		        score += 100;
		        pg.health = 10;
	        }
	
	oe_text.innerHTML = enemies.length;
	ob_text.innerHTML = bullets.length;
	op_text.innerHTML = powerups.length;
	mh_text.innerHTML = pg.health;
	gr_text.innerHTML = pg.graze;
	
	// increment currentLevel
	if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && level.finished == 1)
	{
	        currentLevel += 1;
	        play();
	}
				
	// increment frame
	frame_text.innerHTML = now++;

	// handle player death ; debug mode feature
	if (pg.health == 0)
	{
		for (var i = 0; i < document.gameMode.mode.length; i++)
		{

			if (document.gameMode.mode[0].checked == true)
			{
				document.getElementById("box2").checked = false;

				pg.dead = 1;

				if (pg.dead == 1)
				{
					script_txt.innerHTML = "Game Over, please try again !!"
					clearInterval(interval);
				}
			}
			else if (document.gameMode.mode[1].checked == true)
			{
				document.getElementById("box1").checked = false;

				pg.health = 10;
			}
		}
	        
	}
}

// "Play" button onclick, reset everything, start game
function play()
{
	clearInterval(interval);
	
	now = 0;
	score = 0;
	bg = new Background();
	pg = new Player();
	pg.image = img_pg;
	pg.movement = new Movement(0, bg.w/2, bg.h-50, 0, 0);
	
	bullets = [];
	enemies = [];
	powerups = [];
	others = [];
	
	up_p = 0;
	dw_p = 0;
	lf_p = 0;
	rg_p = 0;
	sh_p = 0;
	s2_p = 0;
	s3_p = 0;
	sm_p = 0;


	// full powerups, level select
	for (var i = 0; i < document.gameMode.mode.length; i++)
	{
	        if (document.gameMode.mode[2].checked == true)
	        {
		pg.power = 60;
	        }

	        if (document.gameMode.mode[3].checked == true)
	        {
		currentLevel = 2;
	        }
	        else if (document.gameMode.mode[4].checked == true)
	        {
		currentLevel = 3;
	        }
	        else if (document.gameMode.mode[5].checked == true)
	        {
		currentLevel = 4;
	        }
	        else if (document.gameMode.mode[i].checked == false)
	        {
		currentLevel = 1;
	        }
	}
		
	// level handler
	if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 1)
	{
		echo("STAGE ONE - Open Sesame!");
		echoAdds("Marisa is curious about her vision and heads off to investigate...");
		level = generateLevel1();		

		script_txt.innerHTML = "Marisa decided to hear off to the place that she saw in her dream.<br>She senses that there is a powerfull magician behind this,<br> for a Youkai this magic is way to strong...";
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 2)
	{
		echo("STAGE TWO - Wastelands!");
		echoAdds("After defeating Keine Marisa follows a shady character into the wastelands...");
		level = generateLevel2();
		if (pg.health < 10)
		{
		        pg.health = 10;
		}
		else if (bombs < 3)
		{
		        bombs = 3;
		}

		script_txt.innerHTML = "The desert sands here are scorching with heat, luckily Marisa keeps a cool head.";
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 3)
	{
		echo("STAGE THREE - Forest of Magic !");
		echoAdds("Marisa senses the magic gets stronger near the forest...")
		level = generateLevel3();
		if (pg.health < 10)
		{
		        pg.health = 10;
		}
		else if (bombs < 3)
		{
		        bombs = 3;
		}

		script_txt.innerHTML = "Theres something strange going on in this place...<br>As the night grew darker the forest seemed to get more dense aswell.<br>Lets find out whats going on here !!";
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 4)
	{
		echo("THE SHOWDOWN - Scarlet Devil!");
		level = generateLevel4();
		if (pg.health < 10)
		{
		        pg.health = 10;
		}
		else if (bombs < 3)
		{
		        bombs = 3;
		}

		script_txt.innerHTML = "After defeating Alice Marisa found out who was playing with this powerfull magic spells,<br>Remilia Scarlet had come across a rare artifact that boosted her powers.<br>Marisa calls her out to face her in battle and obtain the artifact for herself.";
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 5)
	{
		echo("Victory - The End");
		clearInterval(interval);

		script_txt.innerHTML = "you have cleared the game !!";
	}
	
	if (document.getElementById('box7').checked) {
		stopAllMusic();
		startMusic();
	}
	
	// start main game loop
	interval = setInterval(work, 20);
}

// print a big text in the middle of the screen
function echo(text)
{
	var t = new Text();
	t.text = text;
	t.size = 24;
	var m = new Movement(0, bg.w/2, bg.h/2, 0, 0);
	m.tl = 100;
	t.addMovement(m);
	others[others.length] = t;
}

// print additional texts
function echoAdds(text)
{
	var t = new Text();
	t.text = text;
	t.size = 20;
	t.color = "white";
	var m = new Movement(0, bg.w/2, bg.h/2+60, 0, 0);
	m.tl = 80;
	t.addMovement(m);
	others[others.length] = t;
}

// check if a rectangle intersects another
function area_overlap(area1, area2)
{
	return ((area2.x2 < area2.x1 || area2.x2 > area1.x1) &&
	        (area2.y2 < area2.y1 || area2.y2 > area1.y1) &&
	        (area1.x2 < area1.x1 || area1.x2 > area2.x1) &&
	        (area1.y2 < area1.y1 || area1.y2 > area2.y1));
}

// generate random number between sn and en
function rand(sn, en)
{
	return rn = Math.floor(Math.random()*(en-sn+1))+sn;
}
// stop default browser key behaviour
var keys = [];
window.addEventListener("keydown", function(e)
{
        
        keys[e.keyCode] = true;
        
        switch(e.keyCode)
        {
	case 37: case 39: case 38:  case 40:		// Arrow keys
	case 32:
		e.preventDefault();
		break; 			// Space
	default:
		break;			// do not block other keys
        }
},false);

window.addEventListener('keyup', function(e)
{
	keys[e.keyCode] = false;
},false);

// respond to keydown
document.onkeydown = function(e)
{
	if (e.keyCode == 37) lf_p = 1;		// left
	else if (e.keyCode == 38) up_p = 1;	// up
	else if (e.keyCode == 39) rg_p = 1;	// right
	else if (e.keyCode == 40) dw_p = 1;	// down
	else if (e.keyCode == 90) sh_p = 1;	// z: shot
	else if (e.keyCode == 88) s2_p = 1;	// x: bombs
	else if (e.keyCode == 67) s3_p = 1;	// c: special
	else if (e.keyCode == 16) sm_p = 1;	// shift: slow
}

// respond to keyup
document.onkeyup = function(e)
{
	if (e.keyCode == 37) lf_p = 0;		// left
	else if (e.keyCode == 38) up_p = 0;	// up
	else if (e.keyCode == 39) rg_p = 0;	// right
	else if (e.keyCode == 40) dw_p = 0;	// down
	else if (e.keyCode == 90) sh_p = 0;	// z: shot
	else if (e.keyCode == 88) s2_p = 0;	// x: bombs
	else if (e.keyCode == 67) s3_p = 0;	// c: special
	else if (e.keyCode == 16) sm_p = 0;	// shift: slow
}

// stop the game
function stop()
{
	clearInterval(interval);
	script_txt.innerHTML = "the game has stopped";
	
	if (document.getElementById('box7').checked) {
		stopMusic();
	}
}

</script>
