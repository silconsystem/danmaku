<html>

<head>
	<title>Marisa Danmaku</title>
	
	<!-- My Custom Fonts -->
	<link href='http://fonts.googleapis.com/css?family=Bilbo+Swash+Caps' rel='stylesheet' type='text/css'>
</head>

<body>

<div align="center">
	<div style="width: 600px;">
		<h1 style="color: #3399CC; margin: 2px;">Canvas & Javascript Danmaku Game</h1>
		<h2 style="color: #CCCCCC; margin: 2px; font-size: 12px;">Simple 2d shooter made entirely with HTML5 canvas and javascript.<br />Developed by Sako &copy; 2010 - freely redistributable and editable.</h2>
	</div>
	<br />
	<div style="width: 800px;">
		<div style="float: left; width: 550px;">
			<canvas width="500" height="650" id="canv" style"background-color: #000;"></canvas>
		</div>
		<div style="float: left;
		            width: 200px;
		            height: 380px;
		            border: 1px solid #CCCCCC;
		            text-align: left;
		            padding: 0px;
		            font-family: Verdana;
		            font-size: 10px;">
		            
			<b>Informations</b><br />
			Frame: <span id="frame">0</span><br />
			Score: <span id="score">0</span><br />
			Power: <span id="power">0</span><br />
			Grazing: <span id="grazeplus">0</span><br />
			Grazing points: <span id="gr">0</span><br />
			Current Level: <span id="level">0</span><br />
			Marisa Health: <span id="mh">0</span><br />
			<br />
			Onscreen enemies: <span id="oe">0</span><br />
			Onscreen bullets: <span id="ob">0</span><br />
			Onscreen powerups: <span id="op">0</span><br />
			<br />
			<b>Controls</b><br />
			Move: arrow keys - Shoot: Z<br />Hold shift for slow movement<br />
			<br />
			<input type="button" onClick="javascript:play();" value="Play!" style="width: 120px;" />
			<br /><br />
			<b>Features</b><br />
			- no bombs<br />
			
			- final destination<br />
			<br />
			<br />
			Total Score: <span id="total">0</span><br />
		</div>
		<div style="clear: both;"></div>
	</div>
	<br />
	<div style="width: 600px;">
		Requirements: decent computer and Firefox. Close all other tabs for better performance. 
	</div>
</div>

<div style="display: none;">
	<img id="ex" src="img/098.png" />
	<img id="p" src="img/199.png" />
	<img id="s" src="img/056.png" />
	<img id="b6a" src="img/b6a.png" />
	<img id="b8a" src="img/b8a.png" />
	<img id="b8b" src="img/b8b.png" />
	<img id="b8c" src="img/b8c.png" />
	<img id="b8d" src="img/b8d.png" />
	<img id="b8e" src="img/b8e.png" />
	<img id="b8f" src="img/b8f.png" />
	<img id="b8g" src="img/b8g.png" />
	<img id="b8h" src="img/b8h.png" />
	<img id="b8i" src="img/b8i.png" />
	<img id="b8j" src="img/b8j.png" />
	<img id="b16a" src="img/b16a.png" />
	<img id="b16b" src="img/b16b.png" />
	<img id="b16c" src="img/b16c.png" />
	<img id="b16d" src="img/b16d.png" />
	<img id="b16e" src="img/b16e.png" />
	<img id="b16f" src="img/b16f.png" />
	<img id="b16g" src="img/b16g.png" />
	<img id="b16h" src="img/b16h.png" />
	<img id="b16i" src="img/b16i.png" />
	<img id="b16j" src="img/b16j.png" />
	<img id="bp" src="img/bp.png" />
	<img id="pg" src="img/154.png" />
	<img id="e1" src="img/157.png" />
	<img id="e2" src="img/152.png" />
	<img id="e3" src="img/153.png" />
	<img id="e4" src="img/099.png" />
	<img id="e5" src="img/100.png" />
	<img id="e6" src="img/161.png" />
	<img id="e7" src="img/162.png" />
	<img id="bs2" src="img/bs2.png" />
</div>

</body>

</html>

<script type="text/javascript">
// inheritance function
function extend(childClassOrObject, parentClassOrObject)
{ 
	childClassOrObject.prototype = new parentClassOrObject;
	childClassOrObject.prototype.constructor = childClassOrObject;
} 
</script>

<script type="text/javascript" src="js/Background.js"></script>

<script type="text/javascript" src="js/Movement.js"></script>
<script type="text/javascript" src="js/SpellCard.js"></script>

<script type="text/javascript" src="js/Sprite.js"></script>

<script type="text/javascript" src="js/Player.js"></script>
<script type="text/javascript" src="js/PlayerBullet.js"></script>
<script type="text/javascript" src="js/Enemy.js"></script>
<script type="text/javascript" src="js/EnemyBullet.js"></script>
<script type="text/javascript" src="js/Powerup.js"></script>
<script type="text/javascript" src="js/Explosion.js"></script>
<script type="text/javascript" src="js/Text.js"></script>

<script type="text/javascript" src="js/Level.js"></script>

<script type="text/javascript" src="levels/level1.js"></script>
<script type="text/javascript" src="levels/level2.js"></script>
<script type="text/javascript" src="levels/level3.js"></script>
<script type="text/javascript" src="levels/level4.js"></script>

<script type="text/javascript">

// canvas variables
var canv = document.getElementById('canv');
var ctx = canv.getContext('2d');

// document text elements
var frame_text = document.getElementById('frame');
var score_text = document.getElementById('score');
var power_text = document.getElementById('power');
var graze_text = document.getElementById('grazeplus');
var total_text = document.getElementById('total');
var level_text = document.getElementById('level');

var oe_text = document.getElementById('oe');
var ob_text = document.getElementById('ob');
var op_text = document.getElementById('op');
var mh_text = document.getElementById('mh');
var gr_text = document.getElementById('gr');

// document images
var img_p = document.getElementById('p');
var img_s = document.getElementById('s');

var img_e1 = document.getElementById('e1');
var img_e2 = document.getElementById('e2');
var img_e3 = document.getElementById('e3');
var img_e4 = document.getElementById('e4');
var img_e5 = document.getElementById('e5');
var img_e6 = document.getElementById('e6');
var img_e7 = document.getElementById('e7');
var img_b6a = document.getElementById('b6a');
var img_b8a = document.getElementById('b8a');
var img_b8b = document.getElementById('b8b');
var img_b8c = document.getElementById('b8c');
var img_b8d = document.getElementById('b8d');
var img_b8e = document.getElementById('b8e');
var img_b8f = document.getElementById('b8f');
var img_b8g = document.getElementById('b8g');
var img_b8h = document.getElementById('b8h');
var img_b8i = document.getElementById('b8i');
var img_b8j = document.getElementById('b8j');
var img_b16a = document.getElementById('b16a');
var img_b16b = document.getElementById('b16b');
var img_b16c = document.getElementById('b16c');
var img_b16d = document.getElementById('b16d');
var img_b16e = document.getElementById('b16e');
var img_b16f = document.getElementById('b16f');
var img_b16g = document.getElementById('b16g');
var img_b16h = document.getElementById('b16h');
var img_b16i = document.getElementById('b16i');
var img_b16j = document.getElementById('b16j');
var img_bs2 = document.getElementById('bs2');

var img_pg = document.getElementById('pg');
var img_bp = document.getElementById('bp');

var img_ex = document.getElementById('ex');

// other variables
var now = 0;
var score = 0;
var interval = 0;
var currentLevel = 1;

var bg = new Background(); // background global variable 
var pg = new Player(); // player global variable
var level = new Level(); // level global variable

bg.clear();

// sprite arrays
var bullets = [];
var enemies = [];
var powerups = [];
var others = [];

// which buttons have been pressed
var up_p = 0;
var dw_p = 0;
var lf_p = 0;
var rg_p = 0;
var sh_p = 0;
var sm_p = 0;

// function to be called every frame, manages all the gameplay
function work()
{
	// handle background
	bg.work();
	
	// handle player
	pg.work();

	// handle enemies
	for (var i = 0; i < enemies.length; i++)
	{
		var o = enemies[i];
		o.work();
		
		if (o.dead == 1)
			enemies.splice(i, 1);
	}
	
	// handle bullets
	for (var i = 0; i < bullets.length; i++)
	{
		var o = bullets[i]; 
		o.work();
		
		if (o.dead == 1)
			bullets.splice(i, 1);
	}
  
	// handle powerups
	for (var i = 0; i < powerups.length; i++)
	{
		var o = powerups[i]; 
		o.work();
		
		if (o.dead == 1)
			powerups.splice(i, 1);
	}
	
	// handle other misc sprites
	for (var i = 0; i < others.length; i++)
	{
		var o = others[i]; 
		o.work();
		
		if (o.dead == 1)
			others.splice(i, 1);
	}

	// handle enemy spawning
	var spawned = this.level.spawn(); // get array of enemies spawn in the current frame
	
	for (var i = 0; i < spawned.length; i++)
	    enemies[enemies.length] = spawned[i];
	
	var graze_score = score*pg.graze; 
	
	// print stuff
	score_text.innerHTML = score;
	power_text.innerHTML = pg.power;
	
	        if (pg.power >= 60)
	        {
		        power_text.innerHTML = "MAX !!!"
	        }
	
	graze_text.innerHTML = graze_score;
	total_text.innerHTML = score + graze_score;
	level_text.innerHTML = currentLevel;
	oe_text.innerHTML = enemies.length;
	ob_text.innerHTML = bullets.length;
	op_text.innerHTML = powerups.length;
	mh_text.innerHTML = pg.health;
	gr_text.innerHTML = pg.graze;
	
	// handle player death
	if (pg.health == 0)
	{
		pg.dead = 1;
	        
		//if (pg.dead == 1)
		//{
		//	clearInterval(interval);
		//	alert("Game Over!")
		//}
	}
	
	// increment currentLevel
	if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && level.finished == 1)
	{
	        currentLevel += 1;
	        play();
	}
				
	// increment frame
	frame_text.innerHTML = now++;
}

// "Play" button onclick, reset everything, start game
function play()
{
	clearInterval(interval);
	
	now = 0;
	score = 0;
	bg = new Background();
	pg = new Player();
	pg.image = img_pg;
	pg.movement = new Movement(0, bg.w/2, bg.h-50, 0, 0);
	
	bullets = [];
	enemies = [];
	powerups = [];
	others = [];
	
	up_p = 0;
	dw_p = 0;
	lf_p = 0;
	rg_p = 0;
	sh_p = 0;
	sm_p = 0;
	
	// level handler
	if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 1)
	{
		echo("STAGE ONE - Gensokyo Border!");
		echoAdds("Marisa is curious about her vision and heads off to investigate...");
		level = generateLevel1();
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 2)
	{
		echo("STAGE TWO - Scarlet Mansion Garden!");
		echoAdds("You decide to check the mistress her garden out yourself...");
		level = generateLevel2();
		pg.health = 10;
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 3)
	{
		echo("STAGE THREE - Forest of Magic !");
		level = generateLevel3();
		pg.health = 10;
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 4)
	{
		echo("STAGE FOUR - Human Village!");
		level = generateLevel4();
		pg.health = 10;
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 5)
	{
		echo("THE SHOWDOWN - Scarlet Devil!");
		level = generateLevel5();
		pg.health = 10;
	}
	else if (powerups.length == 0 && enemies.length == 0 && bullets.length == 0 && currentLevel == 6)
	{
		echo("Victory - The End");
		clearInterval(interval);
	}
	
	// start main game loop
	interval = setInterval(work, 16);
}

// print a big text in the middle of the screen
function echo(text)
{
	var t = new Text();
	t.text = text;
	t.size = 24;
	var m = new Movement(0, bg.w/2, bg.h/2, 0, 0);
	m.tl = 100;
	t.addMovement(m);
	others[others.length] = t;
}

// print additional texts
function echoAdds(text)
{
	var t = new Text();
	t.text = text;
	t.size = 20;
	t.color = "white";
	var m = new Movement(0, bg.w/2, bg.h/2+60, 0, 0);
	m.tl = 80;
	t.addMovement(m);
	others[others.length] = t;
}

// check if a rectangle intersects another
function area_overlap(area1, area2)
{
	return ((area2.x2 < area2.x1 || area2.x2 > area1.x1) &&
	        (area2.y2 < area2.y1 || area2.y2 > area1.y1) &&
	        (area1.x2 < area1.x1 || area1.x2 > area2.x1) &&
	        (area1.y2 < area1.y1 || area1.y2 > area2.y1));
}

// generate random number between sn and en
function rand(sn, en)
{
	return rn = Math.floor(Math.random()*(en-sn+1))+sn;
}

// respond to keydown
document.onkeydown = function(e)
{
	if (e.keyCode == 37) lf_p = 1;
	else if (e.keyCode == 38) up_p = 1;
	else if (e.keyCode == 39) rg_p = 1;
	else if (e.keyCode == 40) dw_p = 1;
	else if (e.keyCode == 90) sh_p = 1;
	else if (e.keyCode == 16) sm_p = 1;
}

// respond to keyup
document.onkeyup = function(e)
{
	if (e.keyCode == 37) lf_p = 0;
	else if (e.keyCode == 38) up_p = 0;
	else if (e.keyCode == 39) rg_p = 0;
	else if (e.keyCode == 40) dw_p = 0;
	else if (e.keyCode == 90) sh_p = 0;
	else if (e.keyCode == 16) sm_p = 0;
}

</script>
